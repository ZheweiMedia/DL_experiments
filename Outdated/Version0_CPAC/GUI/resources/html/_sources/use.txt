Using C-PAC
===========
Overview
--------
This page will guide you through the process of:

* Creating a subject list.
* Configuring an analysis pipeline.
* Running individual-level analysis.
* Running group-level analysis.


Open CPAC
---------
To open the CPAC GUI, simply enter the command ``cpac_gui`` in a terminal window. You will be presented with the main CPAC window.  **Note: You may receive an error about a 'known incorrect sRGB profile' if you are running the GUI within Anaconda/Miniconda on some machines.  This will not affect C-PAC performance and can be ignored.**

.. figure:: /_images/main_gui.png

Specify a Subject List
----------------------
The first step in running CPAC is to generate a list of subjects and data to process. For detailed instructions on how to do this, as well as how to configure :doc:`Slice Timing Correction </slice>`, please see the :doc:`Subject List Setup Page</data_config>`.

If you would like to use a previously generated subject list, click the Load button and select the appropriate ``.yml`` subject list file. If you have loaded multiple subject lists, use the checkboxes to select which subject lists you would like to run.  **Note: Do not confuse the 'Load' button on this window with the 'Load Settings' button on the Subject List Setup window.  The latter button is intended to reload configuration files that the subject list setup dialogue can use to create subject lists.  It will not work with other YAML files.**


Configure a Pipeline
--------------------
Once you have specified a subject list, you are ready to create a new analysis pipeline. For detailed instructions on how to configure a particular CPAC function, see the following pages:

* :doc:`Computer Settings </compute_config>`
* :doc:`Anatomical Preprocessing </anat>`
* :doc:`Slice Timing Correction </slice>`
* :doc:`Motion Correction </motion>`
* :doc:`Nuisance Corrections </nuisance>`
* :doc:`Temporal Filtering </temporal>`
* :doc:`Time Series Extraction </tse>`
* :doc:`Seed-based Correlation Analysis </sca>`
* :doc:`Dual Regression </dual_reg>`
* :doc:`Regional Homogeneity </reho>`
* :doc:`Voxel-mirrored Homotopic Connectivity </vmhc>`
* :doc:`ALFF and fALFF </alff>`
* :doc:`Network Centrality </centrality>`
* :doc:`Smoothing </smoothing>`

When you have finished configuring your pipeline, click Save. You will be asked to specify a location to save a configuration file containing information about the pipeline, and to specify a name for the pipeline.

To modify an existing pipeline, select it and click Edit. To use a previously configured pipeline, click Load and select the appropriate ``.yml`` configuration file. If you have loaded multiple pipelines, use the checkboxes to select which pipelines you would like to run. 

Running Preprocessing and Individual-Level Analysis
---------------------------------------------------
When you are ready to run CPAC, select the subject lists and pipelines you would like to run and click the Run Individual Level Analysis button.

The following schematic illustrates the order in which C-PAC executes.

.. figure:: /_images/processing_workflow.png

Viewing Run Status
------------------
**Note:** Status log pages are currently under development, and their look and functionality will change in future releases.

To view the status of a CPAC run (how many subjects have been processed, whether any errors have been encountered, etc), you can view the log files located in the ``/logs`` folder of your output directory. Double-click on the ``/reports/index.html`` file to open it in your browser.

.. figure:: /_images/logs_main.png


Viewing CPAC Outputs
--------------------
**Note:** QC pages are currently under development, and their look and functionality will change in future releases.

If you have enabled it in your pipeline configuration, the CPAC Quality Control (QC) interface is the most efficient way to rapidly view the outputs of a CPAC run. For each subject, CPAC generates an HTML file containing images of each output and additional information such as motion parameters and signal-to-noise ratios.

.. figure:: /_images/qc_main.png

Though it is possible to view the QC page for each subject individually, we recommend generating a combined QC page that lets you easily navigate between subjects. To do this, open a python terminal and run the following command::

  import CPAC
  CPAC.utils.create_all_qc.run('/path/to/output_directory')

Alternately, it is of course possible to simply view CPAC outputs using the application of your choice. For more information about the outputs generated by CPAC and the directory structure in which they are organized, please see the :doc:`Outputs Page </outputs>`.

Running Group-Level Analysis
----------------------------
To run BASC, CWAS, or FSL Group Analysis you must have already run preprocessing and individual-level analysis. To configure group-level analysis, select a pipeline for which you have run preprocessing and individual-level anlaysis, then click Edit. See the following pages for information on configuring group-level analysis functions:

* :doc:`Bootstrap Analysis of Stable Clusters </basc>`
* :doc:`Connectome-wide Association Studies </cwas>`
* :doc:`FSL Group Analysis </fsl_ga>`

When you are finished configuring the pipeline for group-level analysis, click save.

As C-PAC allows you to specify multiple processing pipelines, a single run can result in multiple individual-level output files for a given subject, calculated with slightly different settings. When running group-level analyses, you must specify which processing strategies you would like to include.

When you are ready to run group-level analysis, select the subject lists and pipelines you would like to run and click the Run Group Level Analysis button. You will be presented with a dialog and asked to select which strategies you would like to include.

.. toctree::
   :hidden: 

   Ready Your Data <data_config>
   Computer Settings <compute_config>
   Directory Setup <dir_config>
   Data Output <output>
