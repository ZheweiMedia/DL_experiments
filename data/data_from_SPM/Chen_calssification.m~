%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
%   1. Repeat Chen's method to classification.
%   2. Person independent.
%
%
%
%
%
%
%




cd ~/Zhewei/data/data_from_SPM/

load('dataList.mat')

% subjects: 48
subjectNo = 48;
index = randperm(subjectNo);
train_index = index(1:45);
test_index = index(46:end);

fMRI_train_NC_IID = [];
fMRI_train_AD_IID = [];
fMRI_test_IID = [];
Label_test = [];
for i_train = 1:45
    if strcmp(char(data{train_index(i_train),1}), 'AD')
        fMRI_train_AD_IID = [fMRI_train_AD_IID data{train_index(i_train),2}];
    else
        fMRI_train_NC_IID = [fMRI_train_NC_IID data{train_index(i_train),2}];
    end
end

for i_test = 1:3
    fMRI_test_IID = [fMRI_test_IID data{test_index(i_test),2}];
    if strcmp(char(data{test_index(i_test),1} == 'AD'
        Label_test = [label_test zeros(length(data{test_index(i_test),2}))];
    else
        Label_test = [label_test ones(length(data{test_index(i_test),2}))];
    end
end
    

fMRI_train_IID = [346237, 358614, 372812, 398684, 264986, ...
            264987, 293808, 293809, 335306, 335307, ...
            390346, 258600, 258605, 272407, 272411, ...
            302039, 302042, 340021, 340024, 393209, ...
            287992, 287986, 310931, 310925, 336552, ...
            336551, 322009, 322000, 346367, 346359, ...
            362021, 394330, 360323, 373417, 390453, ...
            301395, 321520, 343571, 306073, 327941, ...
            348646, 360317, 382187, 258955, 272535, ...
            300352, 341972, 396530, 396527, 280778, ...
            297106, 322347, 359770, 412884, 300334, ...
            317435, 343285, 363190, 343912, 358050, ...
            372599, 400431, 345555, 358811, 372471, ...
            415205, 228872, 248870, 263860, 297847, ...
            357475, 372254, 389296, 415178, 376933, ...
            368413, 291229, 323796, 347092, 295969, ...
            316009, 342048, 367094, 300043, 322371, ...
            342223, 369943, 306375, 335235, 352396, ...
            ];
fMRI_test_IID = [238623, 303069, 240811, 304790, 371994, ...
            243902, 322442, 286519, 361612, 287493, ...
            361431, 254581, 273218, 290923, 335999, ...
            391150, 257271, 274579, 297353, 340048, ...
            395105, 259654, 274825, 299159, 346113, ...
            397604, 259806, 260580, 277135, 301757, ...
            346801, 398533, 395980, 265132, 265125, ...
            289854, 289846, 336212, 336216, 389367, ...
            268917, 268914, 286461, 286464, 311257];
        
addpath(genpath('~/Zhewei/MatLabCode/'))        
%% read files in

[~,train_numfiles] = size(fMRI_train_IID);
lowFreq = 0.01;
hiFreq = 0.08;
fs = 1/3;
feature_No = 120;


for ifile = 1:train_numfiles
    fileID = fMRI_train_IID(ifile);
    cd ~/Zhewei/data/data_from_SPM/
    fMRI_train{ifile,1} = fileID;
    mat_name = strcat(num2str(fMRI_train_IID(ifile)), '.mat');
    feature = load(mat_name);
    feature = feature.feature;
    [m_f, n_f] = size(feature);
    tmp_feature = zeros(m_f, n_f);
    for jframe = 1:feature_No
        tmp_feature(jframe, :) = bpfilt(feature(jframe, :), lowFreq, hiFreq, fs, 0);
    end
    fMRI_train{ifile,2} = tmp_feature;
    fMRI_train{ifile,3} = corrcoef(tmp_feature');
 
end


[~,test_numfiles] = size(fMRI_test_IID);

for ifile = 1:test_numfiles
    fileID = fMRI_test_IID(ifile);
    cd ~/Zhewei/data/data_from_SPM/
    fMRI_test{ifile,1} = fileID;
    mat_name = strcat(num2str(fMRI_test_IID(ifile)), '.mat');
    feature = load(mat_name);
    feature = feature.feature;
    [m_f, n_f] = size(feature);
    tmp_feature = zeros(m_f, n_f);
    for jframe = 1:feature_No
        tmp_feature(jframe, :) = bpfilt(feature(jframe, :), lowFreq, hiFreq, fs, 0);
    end
    fMRI_test{ifile,2} = tmp_feature;
    fMRI_test{ifile,3} = corrcoef(tmp_feature');
 
end



%% Wilcoxon rank sum test
W_matrix = zeros(120,120);
for i_feature1 = 1:120
    for i_feature2 = 1:120
        % build x_NC, and y_AD
        x_NC = [];
        for ifile = 1:train_numfiles
            x_NC = [x_NC fMRI_train{ifile,3}(i_feature1, i_feature2)];
        end
        y_AD = [];
        for ifile = 1:AD_numfiles
            y_AD = [y_AD fMRI_AD{ifile,3}(i_feature1, i_feature2)];
        end
        
        % rank sum
        [p,h,stats] = ranksum(x_NC,y_AD);
        W_matrix(i_feature1, i_feature2) = stats.zval;
    end
end